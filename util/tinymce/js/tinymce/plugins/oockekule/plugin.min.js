(function(tinymce){
  tinymce.create('tinymce.plugins.OOCKekule', {
    init: function(editor, url) {
      var options = editor.getParam('oockekule') || {};
      var path = options.path || url;
      editor.addButton('oockekule', {
      image: url + '/benz_icon.png',
        tooltip: '2D/3D Kekule Structure (Interactive)',
        onclick: showFormulaDialog.bind(this, editor, path),
        onPostRender: function() {
          var _this = this;   // reference to the button itself
          editor.on('NodeChange', function(e) {
            _this.active((e.element.className == 'K-Chem-Viewer2D' || e.element.className == 'K-Chem-Viewer3D') && e.element.nodeName.toLowerCase() == "img");
          })
        }
      });
    }
  });
  //tinymce.PluginManager.requireLangPack('oockekule','en,es,fr_FR');
  tinymce.PluginManager.add('oockekule', tinymce.plugins.OOCKekule);


  function showFormulaDialog(editor, url) {
    editor.windowManager.open({
      title: "Create/Insert 2D/3D Structure",
      width : 900,
      height : 610,
      html: buildIFrame(editor, url),
      buttons: []
    });
  }

  function buildIFrame(editor, url){
    var currentNode = editor.selection.getNode();
    //var molecule = '';
    var uniqidurl = '';
    if (currentNode.nodeName.toLowerCase() == 'img' && (currentNode.className == 'K-Chem-Viewer2D' || currentNode.className == 'K-Chem-Viewer3D'))  {

    	chemobj = currentNode.getAttribute('data-chem-obj');
        //var kjsdata = tinymce.activeEditor.dom.select('#'+uniqid)[0].innerHTML;
        //uniqidurl = '?uniqid=' + uniqid;
    }
    //var html = "<iframe style='z-index: 9000; overflow:hidden;' id='kekuleiframe' src = '" +url + "/dialog.html"+uniqidurl+"'></iframe>";
        var html = "<iframe scrolling='no' style='display: flex;' id='kekuleiframe' src = '" +url + "/dialog.html'></iframe>";
    return html;
  }
})(window.tinymce);
